@page "/admin/logs"
@using AiCV.Application.Interfaces
@using AiCV.Domain.Entities
@using AiCV.Application.Common
@attribute [Authorize(Roles = Roles.Admin)]
@inject ISystemLogService LogService
@inject IDialogService DialogService
@inject IStringLocalizer<AiCV.Infrastructure.Resources.AicvResources> Localizer

<PageTitle>@Localizer["SystemLogs"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4" Wrap="Wrap.Wrap">
        <MudText Typo="Typo.h5">ðŸ“‹ @Localizer["SystemLogs"]</MudText>
        <MudSpacer />
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                OnClick="ClearLogs">@Localizer["ClearOldLogs"]</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                OnClick="RefreshLogs">@Localizer["Refresh"]</MudButton>
        </MudStack>
    </MudStack>

    <MudCard Elevation="3">
        <MudTable ServerData="@ServerReload" Dense="true" Hover="true" Striped="true" @ref="_table" T="SystemLog"
            Elevation="0">
            <ToolBarContent>
                <MudText Typo="Typo.h6">@Localizer["LogEntries"]</MudText>
                <MudSpacer />
                <MudSelect T="string" Label="@Localizer["Level"]" @bind-Value="_filterLevel"
                    AdornmentIcon="@Icons.Material.Filled.FilterList" SelectedValuesChanged="OnFilterChanged"
                    Class="d-flex" Style="min-width: 150px;">
                    <MudSelectItem Value="@((string?)null)">@Localizer["AllLevels"]</MudSelectItem>
                    <MudSelectItem Value="@("Error")">@Localizer["Error"]</MudSelectItem>
                    <MudSelectItem Value="@("Warning")">@Localizer["Warning"]</MudSelectItem>
                    <MudSelectItem Value="@("Info")">@Localizer["Info"]</MudSelectItem>
                </MudSelect>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>@Localizer["Timestamp"]</MudTh>
                <MudTh>@Localizer["Level"]</MudTh>
                <MudTh>@Localizer["Message"]</MudTh>
                <MudTh>@Localizer["Source"]</MudTh>
                <MudTh>@Localizer["Path"]</MudTh>
                <MudTh>@Localizer["User"]</MudTh>
                <MudTh>@Localizer["Actions"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="@Localizer["Timestamp"]">@context.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</MudTd>
                <MudTd DataLabel="@Localizer["Level"]">
                    <MudChip T="string" Size="Size.Small" Color="@GetLevelColor(context.Level)">@context.Level
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="@Localizer["Message"]">
                    <MudText Typo="Typo.body2"
                        Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;">
                        @context.Message
                    </MudText>
                </MudTd>
                <MudTd DataLabel="@Localizer["Source"]">@context.Source</MudTd>
                <MudTd DataLabel="@Localizer["Path"]">@context.RequestPath</MudTd>
                <MudTd DataLabel="@Localizer["User"]">@(context.UserId ?? Localizer["Anonymous"])</MudTd>
                <MudTd DataLabel="@Localizer["Actions"]">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                        OnClick="@(() => ShowDetails(context))" />
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    </MudCard>
</MudContainer>

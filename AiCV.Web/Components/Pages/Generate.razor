@page "/generate"

@attribute [Authorize]

<PageTitle>Your AI-powered career assistant</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4 d-print-none">🆕 Generate Application</MudText>

    <MudGrid>
        <MudItem xs="12" Class="d-print-none">
            <div class="d-print-none">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-1">📋 Job Details</MudText>
                    <MudForm @ref="_form">
                        <MudGrid Class="mb-2">
                            <MudItem xs="12" sm="6" md="3">
                                <MudSelect T="AIModel" Label="Model" @bind-Value="_selectedModel"
                                    Variant="Variant.Outlined" Clearable="true" HelperText="Select the AI model"
                                    Disabled="_isLoadingModels">
                                    @if (_isLoadingModels)
                                    {
                                        <MudSelectItem Value="AIModel.Gpt4o">Loading models...</MudSelectItem>
                                    }
                                    else
                                    {
                                        @foreach (var model in _availableModels)
                                        {
                                            <MudSelectItem Value="@model">@GetModelDisplayName(model)</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudTextField @bind-Value="_job.CompanyName" Label="Company Name"
                                    Variant="Variant.Outlined" Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.Business" Clearable="true"
                                    HelperText="Will be Auto-detected" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudTextField @bind-Value="_job.Title" Label="Job Title" Variant="Variant.Outlined"
                                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Work"
                                    Clearable="true" HelperText="Will be Auto-detected" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3" Class="d-flex align-center pt-md-4">
                                <MudSwitch @bind-Value="_manualEntry" Color="Color.Primary" Label="Manual Entry Mode"
                                    T="bool" />
                            </MudItem>
                        </MudGrid>

                        @if (!_manualEntry)
                        {
                            <MudGrid Class="mb-3" Spacing="2">
                                <MudItem xs="12" sm="9" md="10">
                                    <MudTextField @bind-Value="_job.Url" Label="Job URL" Variant="Variant.Outlined"
                                    Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Link"
                                    Required="true" RequiredError="" Clearable="true" />
                                </MudItem>

                                <MudItem xs="12" sm="3" md="2" Class="d-flex align-center">
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large"
                                    OnClick="FetchJobDetails" Disabled="_isFetching"
                                    StartIcon="@Icons.Material.Filled.CloudDownload" FullWidth="true" Class="mt-1">
                                        @if (_isFetching)
                                        {
                                            <AiCV.Web.Components.Shared.LoadingIndicator />
                                        }
                                        else
                                        {
                                            <MudText>Fetch</MudText>
                                        }
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        }

                        @if (_showAdvancedEditor || _manualEntry)
                        {
                            int _min = 10;
                            int _max = 90;

                            <div class="d-flex flex-grow-1 stack-on-mobile"
                            style="min-height: 400px; height: 60vh; width: 100%;">
                                <MudPaper Width="@($"{_splitterSize}%")" Class="d-flex flex-column width-100-mobile"
                                Style="height: 100%;" Elevation="0">
                                    <div class="d-flex justify-space-between align-center">
                                        <MudText Typo="Typo.caption">Editor (Markdown) | Job Description</MudText>
                                        <MudTooltip Text="Clear Content">
                                            <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep" Size="Size.Small"
                                            Color="Color.Error" OnClick="ClearEditor" />
                                        </MudTooltip>
                                    </div>
                                    <div class="flex-grow-1" style="overflow-y: auto;">
                                        <MudTextField @bind-Value="_job.Description" Variant="Variant.Outlined"
                                        Required="true" RequiredError="" AutoGrow="true" Class="flex-grow-1"
                                        Style="min-height: 100%;" Immediate="true" DebounceInterval="300"
                                        TextChanged="UpdatePreview" />
                                    </div>
                                </MudPaper>

                                <MudPaper Width="@($"{100 - _splitterSize}%")"
                                Class="d-flex flex-column pl-1 width-100-mobile" Style="height: 100%;" Elevation="0">
                                    <MudText Typo="Typo.caption" Class="mb-1">Preview (HTML)</MudText>
                                    <MudPaper Elevation="0" Outlined="true" Class="pa-4 flex-grow-1"
                                    Style="overflow: hidden; overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                                        @if (string.IsNullOrWhiteSpace(_previewHtml))
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">Preview will appear here...
                                            </MudText>
                                        }
                                        else
                                        {
                                            <div class="markdown-body">
                                                @((MarkupString)_previewHtml)
                                            </div>
                                        }
                                    </MudPaper>
                                </MudPaper>
                            </div>

                            <!--Custom Prompt Field -->
                            <MudTextField @bind-Value="_customPrompt" Label="Custom Instructions (Optional)"
                            Variant="Variant.Outlined" AutoGrow="true" Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Edit" Clearable="true" Counter="1000" MaxLength="1000"
                            HelperText="E.g., 'Focus on leadership skills', 'Use formal tone', 'Keep cover letter under 300 words'"
                            Class="mb-1 mt-4" />

                            <div class="d-flex flex-wrap align-center justify-space-around gap-4 mt-2 py-3 px-2"
                            style="border:1px solid lightgrey; border-radius:4px;">
                                <div class="d-flex align-center justify-center" style="flex: 1 1 250px; max-width: 350px;">
                                    <MudText Typo="Typo.caption" Class="mr-2" Style="white-space: nowrap;">Split:
                                        <strong>@_splitterSize%</strong>
                                    </MudText>
                                    <MudSlider T="int" @bind-Value="@_splitterSize" Min="_min" Max="_max" Step="1"
                                    Variant="Variant.Filled" Color="Color.Primary" ValueLabel="true"
                                    Style="width: 100%;" />
                                </div>
                                <div class="d-flex align-center justify-center" style="flex: 1 1 250px; max-width: 350px;">
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium"
                                    OnClick="GenerateContent" Disabled="_isGenerating"
                                    StartIcon="@Icons.Material.Filled.AutoAwesome" FullWidth="true">
                                        @if (_isGenerating)
                                        {
                                            <AiCV.Web.Components.Shared.LoadingIndicator />
                                            <MudText Class="ms-2">Generating...</MudText>
                                        }
                                        else
                                        {
                                            <MudText>Generate Application</MudText>
                                        }
                                    </MudButton>
                                </div>
                            </div>
                        }
                    </MudForm>
                </MudCard>
            </div>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="3" Class="pa-2" Style="height: 100%;">
                <MudToolBar Class="d-print-none flex-wrap py-2" Style="height: auto; gap: 8px;">
                    <MudText Typo="Typo.h6">✨ Generated Content</MudText>
                    <div class="flex-grow-1 hide-on-mobile"></div>
                    <MudSwitch @bind-Value="_previewCoverLetter" Color="Color.Primary" Label="Visual Preview"
                        Style="@GetDisplayStyle(_activeTabIndex == 0)" />
                    <MudSwitch T="bool" Value="_previewResume" ValueChanged="OnResumePreviewToggled"
                        Color="Color.Primary" Label="Visual Preview" Style="@GetDisplayStyle(_activeTabIndex == 1)" />
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                        StartIcon="@Icons.Material.Filled.ContentCopy"
                        OnClick="@(() => CopyToClipboard(_generatedCoverLetter))"
                        Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">
                        Copy</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="PrintCoverLetter"
                        Disabled="_isPrintingCoverLetter"
                        Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">
                        @if (_isPrintingCoverLetter)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>...</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" />
                            <span>Print</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="@(_isAlreadySaved ? Color.Default : Color.Success)"
                        OnClick="SaveApplication" Disabled="@(_isSaving || _isAlreadySaved)"
                        Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>...</span>
                        }
                        else if (_isAlreadySaved)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                            <span>Saved</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                            <span>Save</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                        StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="CopyResumeJson"
                        Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">Copy JSON
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PrintResume"
                        Disabled="_isPrintingResume"
                        Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">
                        @if (_isPrintingResume)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>...</span>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" />
                            <span>Print CV</span>
                        }
                    </MudButton>
                </MudToolBar>
                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2"
                    KeepPanelsAlive="false" @bind-ActivePanelIndex="_activeTabIndex">
                    <MudTabPanel Text="Cover Letter & Application" Icon="@Icons.Material.Filled.Description">
                        @if (string.IsNullOrEmpty(_generatedCoverLetter))
                        {
                            <MudAlert Severity="Severity.Info">Enter job details and click Generate to create a cover
                                letter.</MudAlert>
                        }
                        else
                        {
                            @if (_previewCoverLetter)
                            {
                                <MudPaper Elevation="0" Class="cv-paper-container d-print-block"
                            Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                    <AiCV.Web.Components.Shared.CoverLetterPreview Profile="_cachedProfile"
                                LetterContent="@_generatedCoverLetter" />
                                </MudPaper>
                            }
                            else
                            {
                                <MudTextField @bind-Value="_generatedCoverLetter" Variant="Variant.Outlined" Lines="25"
                            Class="mb-2 d-print-none" />
                            }
                        }
                    </MudTabPanel>
                    <MudTabPanel Text="Tailored CV" Icon="@Icons.Material.Filled.ContactPage">
                        @if (_generatedResume == null)
                        {
                            <MudAlert Severity="Severity.Info">Enter job details and click Generate to create a tailored CV.
                            </MudAlert>
                        }
                        else
                        {
                            @if (_previewResume)
                            {
                                <MudPaper Elevation="0" Class="cv-paper-container d-print-block"
                            Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                    <AiCV.Web.Components.Shared.CvPreview Profile="_generatedResume" />
                                </MudPaper>
                            }
                            else
                            {
                                <MudStack Row="true" Class="mb-2" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.caption" Color="Color.Warning"><strong>Warning:</strong> You are editing
                                        the raw data structure. Syntax errors will prevent the CV from rendering.</MudText>
                                    <MudSpacer />
                                    <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error"
                                StartIcon="@Icons.Material.Filled.Restore" OnClick="ResetResumeJson">Reset Changes
                                    </MudButton>
                                </MudStack>
                                <MudTextField @bind-Value="_resumeJson" Label="Edit Resume JSON" Variant="Variant.Outlined"
                            Lines="25" Class="mb-2 d-print-none"
                            HelperText="Edit the JSON structure directly. Ensure all keys and string values are quoted." />
                            }
                        }
                    </MudTabPanel>
                    <MudTabPanel Text="Application Email" Icon="@Icons.Material.Filled.Email">
                        @if (string.IsNullOrEmpty(_generatedEmail))
                        {
                            <MudAlert Severity="Severity.Info">Enter job details and click Generate to create an application
                                email.</MudAlert>
                        }
                        else
                        {
                            <MudStack Row="true" Class="mb-2" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.ContentCopy"
                                OnClick="@(() => CopyToClipboard(_generatedEmail))">
                                    Copy Email
                                </MudButton>
                            </MudStack>
                            <MudTextField @bind-Value="_generatedEmail" Variant="Variant.Outlined" Lines="12"
                            Class="mb-2 d-print-none" Label="Application Email"
                            HelperText="Edit the email if needed before copying." />
                        }
                    </MudTabPanel>
                </MudTabs>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<AiCV.Web.Components.Shared.PrintPreviewModal @ref="_printPreviewModal" />

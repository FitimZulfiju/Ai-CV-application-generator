@attribute [Microsoft.AspNetCore.Components.Route(NavUri.GeneratePage)]

@attribute [Authorize]

<PageTitle>@Localizer["GenerateApplication"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-4 d-print-none">ðŸ†• @Localizer["GenerateApplication"]</MudText>

    <MudGrid>
        <MudItem xs="12" Class="d-print-none">
            @*  <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-4">
                    @Localizer["CostDisclaimer"]
                </MudAlert> *@
            <div class="d-print-none">
                <MudCard Elevation="3" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-1">ðŸ“‹ @Localizer["JobDetails"]</MudText>
                    <MudForm @ref="_form">
                        <MudGrid Class="mb-2">
                            <MudItem xs="12" sm="6" md="4">
                                @if (!_hasConfiguredProvider)
                                {
                                        <MudAlert Severity="Severity.Warning" Dense="true">
                                        @Localizer["NoConfigurationsYet"]
                                            <MudLink Href="/settings" Color="Color.Inherit" Class="ml-2">
                                                <b>@Localizer["Settings"]</b>
                                            </MudLink>
                                        </MudAlert>
                                }
                                else
                                {
                                        <MudSelect T="int?" Label="@Localizer["Provider"]" @bind-Value="_activeConfigId"
                                               Variant="Variant.Outlined">
                                        @foreach (var config in _configuredProviders)
                                        {
                                                    <MudSelectItem Value="@((int?)config.Id)">
                                                        <div class="d-flex align-center gap-2">
                                                            <MudIcon Icon="@GetProviderIcon(config.Provider)" Size="Size.Small"
                                                             Color="@GetProviderColor(config.Provider)" />
                                                    @(string.IsNullOrWhiteSpace(config.Name) || config.Name == config.ModelId ? $"{config.Provider} ({config.ModelId})" : $"{config.Provider} ({config.ModelId}) - {config.Name}")
                                                        </div>
                                                    </MudSelectItem>
                                        }
                                        </MudSelect>
                                }
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudTextField @bind-Value="_job.CompanyName" Label="@Localizer["CompanyName"]"
                                              Variant="Variant.Outlined" Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Business" Clearable="true"
                                              HelperText="@Localizer["WillBeAutoDetected"]" Class="pb-0 mb-0" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="3">
                                <MudTextField @bind-Value="_job.Title" Label="@Localizer["JobTitle"]"
                                              Variant="Variant.Outlined" Adornment="Adornment.Start"
                                              AdornmentIcon="@Icons.Material.Filled.Work" Clearable="true"
                                              HelperText="@Localizer["WillBeAutoDetected"]" Class="pb-0 mb-0" />
                            </MudItem>
                            <MudItem xs="12" sm="6" md="2" Class="d-flex align-center pt-0 mt-0">
                                <MudSwitch @bind-Value="_manualEntry" Color="Color.Primary"
                                           Label="@Localizer["ManualEntryMode"]" T="bool" />
                            </MudItem>
                        </MudGrid>

                        @if (!_manualEntry)
                        {
                                <MudGrid Spacing="2">
                                    <MudItem xs="12" sm="9" md="10">
                                        <MudTextField @bind-Value="_job.Url" Label="@Localizer["JobUrl"]"
                                                  Variant="Variant.Outlined" Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Link" Required="true" RequiredError=""
                                                  Clearable="true" />
                                    </MudItem>

                                    <MudItem xs="12" sm="3" md="2" Class="d-flex align-center">
                                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large"
                                               OnClick="FetchJobDetails" Disabled="_isFetching"
                                               StartIcon="@Icons.Material.Filled.CloudDownload" FullWidth="true" Class="mt-1">
                                        @if (_isFetching)
                                        {
                                                    <AiCV.Web.Components.Shared.LoadingIndicator />
                                        }
                                        else
                                        {
                                                    <MudText>@Localizer["Fetch"]</MudText>
                                        }
                                        </MudButton>
                                    </MudItem>
                                </MudGrid>
                        }

                        @if (_showAdvancedEditor || _manualEntry)
                        {
                            int _min = 10;
                            int _max = 90;

                                <div class="d-flex flex-grow-1 stack-on-mobile"
                                 style="min-height: 400px; height: 60vh; width: 100%;">
                                    <MudPaper Width="@($"{_splitterSize}%")" Class="d-flex flex-column width-100-mobile"
                                          Style="height: 100%;" Elevation="0">
                                        <div class="d-flex justify-space-between align-center" style="min-height: 40px;">
                                            <MudText Typo="Typo.caption">
                                            @Localizer["MarkdownEditor"] |
                                            @Localizer["JobDescription"]
                                            </MudText>
                                            <MudTooltip Text="Clear Content">
                                                <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep" Size="Size.Small"
                                                           Color="Color.Error" OnClick="ClearEditor" />
                                            </MudTooltip>
                                        </div>
                                        <MudPaper Outlined="true" Class="flex-grow-1 pa-2" Style="overflow-y: auto;">
                                            <MudTextField @bind-Value="_job.Description" Variant="Variant.Text"
                                                      Required="true" RequiredError="" AutoGrow="true" Class="flex-grow-1"
                                                      Style="min-height: 100%;" Immediate="true" DebounceInterval="300"
                                                      TextChanged="UpdatePreview" />
                                        </MudPaper>
                                    </MudPaper>

                                    <MudPaper Width="@($"{100 - _splitterSize}%")"
                                          Class="d-flex flex-column pl-1 width-100-mobile" Style="height: 100%;" Elevation="0">
                                        <div class="d-flex align-center px-1" style="min-height: 40px;">
                                            <MudText Typo="Typo.caption">@Localizer["PreviewHtml"]</MudText>
                                        </div>
                                        <MudPaper Elevation="0" Outlined="true" Class="pa-4 flex-grow-1"
                                              Style="overflow: hidden; overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                                        @if (string.IsNullOrWhiteSpace(_previewHtml))
                                        {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @Localizer["PreviewWillAppearHere"]
                                                    </MudText>
                                        }
                                        else
                                        {
                                                    <div class="markdown-body">
                                                @((MarkupString)_previewHtml)
                                                    </div>
                                        }
                                        </MudPaper>
                                    </MudPaper>
                                </div>

                                <!--Custom Prompt Field -->
                                <MudTextField @bind-Value="_customPrompt" Label="@Localizer["CustomInstructions"]"
                                          Variant="Variant.Outlined" AutoGrow="true" Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Edit" Clearable="true" Counter="1000" MaxLength="1000"
                                          HelperText="@Localizer["JobDescriptionInstructions"]" Class="mb-1 mt-4" />

                                <div class="d-flex flex-wrap align-center justify-space-around gap-4 mt-2 py-3 px-2"
                                 style="border:1px solid lightgrey; border-radius:4px;">
                                    <div class="d-flex align-center justify-center" style="flex: 1 1 250px; max-width: 350px;">
                                        <MudText Typo="Typo.caption" Class="mr-2" Style="white-space: nowrap;">
                                        @Localizer["Split"]:
                                            <strong>@_splitterSize%</strong>
                                        </MudText>
                                        <MudSlider T="int" @bind-Value="@_splitterSize" Min="_min" Max="_max" Step="1"
                                               Variant="Variant.Filled" Color="Color.Primary" ValueLabel="true"
                                               Style="width: 100%;" />
                                    </div>
                                    <div class="d-flex align-center justify-center" style="flex: 1 1 250px; max-width: 350px;">
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium"
                                               OnClick="GenerateContent" Disabled="_isGenerating"
                                               StartIcon="@Icons.Material.Filled.AutoAwesome" FullWidth="true">
                                        @if (_isGenerating)
                                        {
                                                    <AiCV.Web.Components.Shared.LoadingIndicator />
                                                    <MudText Class="ms-2">@Localizer["Generating"]</MudText>
                                        }
                                        else
                                        {
                                                    <MudText>@Localizer["GenerateApplication"]</MudText>
                                        }
                                        </MudButton>
                                    </div>
                                </div>
                        }
                    </MudForm>
                </MudCard>
            </div>
        </MudItem>

        <MudItem xs="12" Class="pt-2">
            <MudCard Elevation="3" Class="pa-2" Style="height: 100%;">
                <MudToolBar Class="d-print-none flex-wrap py-2" Style="height: auto; gap: 8px;">
                    <MudText Typo="Typo.h6">âœ¨ @Localizer["GeneratedContent"]</MudText>
                    <div class="flex-grow-1 hide-on-mobile"></div>
                    <MudSwitch @bind-Value="_previewCoverLetter" Color="Color.Primary"
                               Label="@Localizer["VisualPreview"]" Style="@GetDisplayStyle(_activeTabIndex == 0)" />
                    <MudSwitch T="bool" Value="_previewResume" ValueChanged="OnResumePreviewToggled"
                               Color="Color.Primary" Label="@Localizer["VisualPreview"]"
                               Style="@GetDisplayStyle(_activeTabIndex == 1)" />
                    <MudTooltip Text="@(HasProfilePicture() ? Localizer["IncludePhotoInCv"] : Localizer["NoProfilePictureUploadOne"])"
                                Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">
                        <MudSwitch T="bool" Value="_includeProfilePicture" ValueChanged="OnIncludeProfilePictureToggled"
                                   Color="Color.Secondary" Label="@Localizer["IncludePhoto"]"
                                   Disabled="@(!HasProfilePicture())"
                                   Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)" />
                    </MudTooltip>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.ContentCopy"
                               OnClick="@(() => CopyToClipboard(_generatedCoverLetter))"
                               Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">
                        @Localizer["Copy"]
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="PrintCoverLetter"
                               Disabled="_isPrintingCoverLetter"
                               Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter) && _activeTabIndex == 0)">
                        @if (_isPrintingCoverLetter)
                        {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>...</span>
                        }
                        else
                        {
                                <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" />
                                <span>@Localizer["Print"]</span>
                        }
                    </MudButton>

                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="CopyResumeJson"
                               Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">
                        @Localizer["CopyJson"]
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PrintResume"
                               Disabled="_isPrintingResume"
                               Style="@GetDisplayStyle(_generatedResume != null && _activeTabIndex == 1)">
                        @if (_isPrintingResume)
                        {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>...</span>
                        }
                        else
                        {
                                <MudIcon Icon="@Icons.Material.Filled.Print" Class="mr-2" />
                                <span>@Localizer["Print"] CV</span>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.ContentCopy"
                               OnClick="@(() => CopyToClipboard(_generatedEmail))"
                               Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedEmail) && _activeTabIndex == 2)">
                        @Localizer["CopyEmail"]
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="@(_isAlreadySaved ? Color.Default : Color.Success)"
                               OnClick="SaveApplication" Disabled="@(_isSaving || _isAlreadySaved)"
                               Style="@GetDisplayStyle(!string.IsNullOrEmpty(_generatedCoverLetter))"
                               StartIcon="@(_isSaving ? null : (_isAlreadySaved ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Save))">
                        @if (_isSaving)
                        {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>...</span>
                        }
                        else if (_isAlreadySaved)
                        {
                                <span>@Localizer["Saved"]</span>
                        }
                        else
                        {
                                <span>@Localizer["Save"]</span>
                        }
                    </MudButton>
                </MudToolBar>
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pt-2"
                         KeepPanelsAlive="false" @bind-ActivePanelIndex="_activeTabIndex">
                    <MudTabPanel Text="@Localizer["CoverLetterAndApplication"]"
                                 Icon="@Icons.Material.Filled.Description">
                        @if (string.IsNullOrEmpty(_generatedCoverLetter))
                        {
                                <MudAlert Severity="Severity.Info">@Localizer["EnterJobDetailsForCoverLetter"]</MudAlert>
                        }
                        else
                        {
                            @if (_previewCoverLetter)
                            {
                                        <MudPaper Elevation="0" Class="cv-paper-container d-print-block"
                                          Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                            <AiCV.Web.Components.Shared.CoverLetterPreview Profile="_cachedProfile"
                                                                                   LetterContent="@_generatedCoverLetter" />
                                        </MudPaper>
                            }
                            else
                            {
                                        <MudTextField @bind-Value="_generatedCoverLetter" Variant="Variant.Outlined" Lines="25"
                                              Class="mb-2 d-print-none" />
                            }
                        }
                    </MudTabPanel>
                    <MudTabPanel Text="@Localizer["TailoredCv"]" Icon="@Icons.Material.Filled.ContactPage">
                        @if (_generatedResume == null)
                        {
                                <MudAlert Severity="Severity.Info">@Localizer["EnterJobDetailsForCv"]</MudAlert>
                        }
                        else
                        {
                            @if (_previewResume)
                            {
                                        <MudPaper Elevation="0" Class="cv-paper-container d-print-block"
                                          Style="overflow-y: auto; max-height: calc(100vh - 250px);">
                                            <AiCV.Web.Components.Shared.CvPreview Profile="_generatedResume" />
                                        </MudPaper>
                            }
                            else
                            {
                                        <MudStack Row="true" Class="mb-2" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.body2" Color="Color.Warning">@Localizer["RawDataWarning"]</MudText>
                                            <MudSpacer />
                                            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Error"
                                               StartIcon="@Icons.Material.Filled.Restore" OnClick="ResetResumeJson">
                                        @Localizer["ResetChanges"]
                                            </MudButton>
                                        </MudStack>
                                        <MudTextField @bind-Value="_resumeJson" Label="@Localizer["EditResumeJson"]"
                                              Variant="Variant.Outlined" Lines="25" Class="mb-2 d-print-none"
                                              HelperText="@Localizer["EditResumeJsonHelper"]" />
                            }
                        }
                    </MudTabPanel>
                    <MudTabPanel Text="@Localizer["ApplicationEmail"]" Icon="@Icons.Material.Filled.Email">
                        @if (string.IsNullOrEmpty(_generatedEmail))
                        {
                                <MudAlert Severity="Severity.Info">@Localizer["EnterJobDetailsForEmail"]</MudAlert>
                        }
                        else
                        {

                                <MudTextField @bind-Value="_generatedEmail" Variant="Variant.Outlined" Lines="12"
                                          Class="mt-0 mr-2 ml-2 d-print-none" Label="@Localizer["ApplicationEmail"]"
                                          HelperText="@Localizer["EditEmailHelper"]" />
                        }
                    </MudTabPanel>
                </MudTabs>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<AiCV.Web.Components.Shared.PrintPreviewModal @ref="_printPreviewModal" />
